<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parallel Simulations · Vahana Documentation</title><meta name="title" content="Parallel Simulations · Vahana Documentation"/><meta property="og:title" content="Parallel Simulations · Vahana Documentation"/><meta property="twitter:title" content="Parallel Simulations · Vahana Documentation"/><meta name="description" content="Documentation for Vahana Documentation."/><meta property="og:description" content="Documentation for Vahana Documentation."/><meta property="twitter:description" content="Documentation for Vahana Documentation."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">Vahana Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="index.html">Introduction</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="tutorial1.html">First Steps</a></li><li><a class="tocitem" href="hegselmann.html">Utilizing Graphs.jl</a></li><li><a class="tocitem" href="predator.html">Adding Spatial Information</a></li></ul></li><li><a class="tocitem" href="performance.html">Performance Tuning</a></li><li class="is-active"><a class="tocitem" href="parallel.html">Parallel Simulations</a><ul class="internal"><li><a class="tocitem" href="#MPI.jl-Integration"><span>MPI.jl Integration</span></a></li><li><a class="tocitem" href="#Partitioning"><span>Partitioning</span></a></li><li><a class="tocitem" href="#Using-@rootonly"><span>Using @rootonly</span></a></li><li><a class="tocitem" href="#Write-a-snapshot-after-finish_init!"><span>Write a snapshot after <code>finish_init!</code></span></a></li><li><a class="tocitem" href="#The-:IgnoreSourceState-hint"><span>The :IgnoreSourceState hint</span></a></li><li><a class="tocitem" href="#Avoid-agentstate-calls"><span>Avoid agentstate calls</span></a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="definition.html">Model Definition</a></li><li><a class="tocitem" href="initialization.html">Initialization</a></li><li><a class="tocitem" href="transition.html">Transition Function</a></li><li><a class="tocitem" href="global.html">Global Layer</a></li><li><a class="tocitem" href="raster.html">Raster</a></li><li><a class="tocitem" href="plots.html">Plots</a></li><li><a class="tocitem" href="hdf5.html">File storage</a></li><li><a class="tocitem" href="logging.html">Logging</a></li><li><a class="tocitem" href="config.html">Configuration</a></li><li><a class="tocitem" href="misc.html">Misc</a></li><li><a class="tocitem" href="apiindex.html">Index</a></li></ul></li><li><a class="tocitem" href="changelog.html">Change Log</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="parallel.html">Parallel Simulations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="parallel.html">Parallel Simulations</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/s-fuerst/Vahana.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/s-fuerst/Vahana.jl/blob/d9cb92b964b886c35a17e56933883e3aac35f81d/docs/src/parallel.md" title="View source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Parallel-simulations"><a class="docs-heading-anchor" href="#Parallel-simulations">Parallel simulations</a><a id="Parallel-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-simulations" title="Permalink"></a></h1><p>Vahana supports parallel simulations using MPI (Message Passing Interface), allowing for significant performance improvements when running large-scale models. To run a Vahana simulation in parallel, you can use the mpirun or mpiexec command, specifying the number of processes with the -np parameter. For example:</p><p><code>mpirun -np 4 julia your_model.jl</code></p><p>The <code>-np</code> parameter indicates the number of processes/threads to be used for the simulation.</p><p>This approach works without any additional changes in the model code. However, there are ways to further optimize performance in a parallel simulation:</p><h2 id="MPI.jl-Integration"><a class="docs-heading-anchor" href="#MPI.jl-Integration">MPI.jl Integration</a><a id="MPI.jl-Integration-1"></a><a class="docs-heading-anchor-permalink" href="#MPI.jl-Integration" title="Permalink"></a></h2><p>Vahana utilizes the MPI.jl package for its parallel computing capabilities. While no specific MPI knowledge is required to use Vahana&#39;s parallel features, users may find it beneficial to review the <a href="https://juliaparallel.org/MPI.jl/stable/configuration/">Configuration section</a> of the <a href="https://juliaparallel.org/MPI.jl/stable/">MPI.jl documentation</a> for a deeper understanding of the underlying parallel computing framework.  For advanced users or specific scenarios, it&#39;s possible to work directly with MPI.jl functions within your Vahana model. When using Vahana in parallel mode, MPI is automatically initialized, and the following MPI-related variables are available:</p><ul><li><code>mpi.comm</code>: The MPI communicator object.</li><li><code>mpi.rank</code>: An integer identifying the current process (0-based).</li><li><code>mpi.size</code>: The total number of processes in the parallel computation.</li></ul><p>Remember that while direct use of MPI functions can provide additional flexibility, it also requires careful handling to maintain consistency across all processes and avoid potential race conditions or deadlocks.</p><h2 id="Partitioning"><a class="docs-heading-anchor" href="#Partitioning">Partitioning</a><a id="Partitioning-1"></a><a class="docs-heading-anchor-permalink" href="#Partitioning" title="Permalink"></a></h2><p>The simulation graph is partitioned and distributed in the <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> call. By default, the <a href="https://github.com/JuliaSparse/Metis.jl">Metis.jl</a> package is used for this. However, during this process, the information about the different agent types is lost. As a result, if multiple agent types are used, it is possible that the number of agents is unevenly distributed for a single agent type.</p><p>To address this issue, an alternative partitioning scheme, <code>:EqualAgentNumbers</code>, is available. However, this scheme ignores the edges and number of cuts in the graph.</p><p>In order to optimize the partitioning for your specific model, it can be very useful to perform your own partitioning and pass it to <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a>. An example of this can be seen in the <code>create_partition</code> function of the <a href="https://git.zib.de/sfuerst/vahana-episim/-/blob/main/src/episim.jl">Vahana Episim Example</a>.</p><h2 id="Using-@rootonly"><a class="docs-heading-anchor" href="#Using-@rootonly">Using @rootonly</a><a id="Using-@rootonly-1"></a><a class="docs-heading-anchor-permalink" href="#Using-@rootonly" title="Permalink"></a></h2><p>It&#39;s helpful to understand that in MPI programs, all processes execute the same program code, but operate on different data. In a typical Vahana program, up to the <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> call, all processes runs the same code that creates the initial graph and therefore, if there are <code>n</code> processes, the complete graph is generated <code>n</code> times. However, at the <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> step, only the graph from process 0 (the root process) is considered, and the graphs constructed on all other processes are discarded.</p><p>Although this is not necessarily problematic, it can be beneficial to construct the graph only on the root processes, especially if files are being read during the initialization phase.</p><p>To execute instructions only on the root process, you can use the <code>@rootonly</code> macro. For example, the <a href="https://git.zib.de/sfuerst/vahana-episim">Vahana Episim example</a> includes the following code before the <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> call:</p><pre><code class="nohighlight hljs">    @rootonly begin
        worldid = add_agent!(sim, World())
        healthauthid = add_agent!(sim, HealthAuthority(0, 0, 0))
        @info &quot;read persons&quot;
        persons = read_persons!(config.synpop_file)
        @info &quot;read events&quot;
        read_events!(sim, config.events_all, persons, worldid, healthauthid)
        @info &quot;finish init&quot;
    end</code></pre><p>Alternatively you could also check the <code>mpi.isroot</code> predicate.</p><p>It is important that <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> is called by all processes and not only by the root process, and also some other functions like e.g. <a href="hdf5.html#Vahana.write_snapshot"><code>write_snapshot</code></a> must be called collectively from all processes.</p><h2 id="Write-a-snapshot-after-finish_init!"><a class="docs-heading-anchor" href="#Write-a-snapshot-after-finish_init!">Write a snapshot after <code>finish_init!</code></a><a id="Write-a-snapshot-after-finish_init!-1"></a><a class="docs-heading-anchor-permalink" href="#Write-a-snapshot-after-finish_init!" title="Permalink"></a></h2><p>If creating the initial state takes time and the process is deterministic, it is a good idea to save the state after <a href="initialization.html#Vahana.finish_init!"><code>finish_init!</code></a> with <a href="hdf5.html#Vahana.write_snapshot"><code>write_snapshot</code></a> and read this snapshot with <a href="hdf5.html#Vahana.read_snapshot!"><code>read_snapshot!</code></a> instead of recreating the graph each time. </p><p>If the process of generating the initial state is time-consuming, it is advisable to save the state after the <code>finish_init!</code> function completes. This can be achieved by calling the <code>write_snapshot</code> function. Subsequently, instead of recreating the initial graph for each simulation, you can read this snapshot using the <code>read_snapshot!</code> function instead.</p><p>The <a href="https://git.zib.de/sfuerst/vahana-episim/-/blob/main/src/episim.jl?ref_type=heads">Vahana Episim example</a> serves as a demonstration of how to implement this approach effectively.</p><h2 id="The-:IgnoreSourceState-hint"><a class="docs-heading-anchor" href="#The-:IgnoreSourceState-hint">The :IgnoreSourceState hint</a><a id="The-:IgnoreSourceState-hint-1"></a><a class="docs-heading-anchor-permalink" href="#The-:IgnoreSourceState-hint" title="Permalink"></a></h2><p>This hint requires additional explanation about what happens internally when <a href="transition.html#Vahana.apply!"><code>apply!</code></a> is called.</p><p>In a parallel simulation, at the beginning of <a href="transition.html#Vahana.apply!"><code>apply!</code></a>, it is checked whether the transition function needs to read the state of an agent type that may have changed since the last state read. If this is the case, it checks all accessible edges (specified in the <code>read</code> argument of <code>apply!</code>) and transmits the state of agents that can be accessed (i.e., the agent type must also be included in the <code>read</code> argument) to the corresponding process. However, there are cases where it is clear that only the IDs of the agents will be accessed via a specific edge type, and not the agent state itself. To avoid the overhead of transmitting state between agents that will never be read, the <code>:IgnoreSourceState</code> hint can be used for those edge types.</p><p>This hint only affects parallel simulations, as there is nothing to transmit in a serial simulation.</p><h2 id="Avoid-agentstate-calls"><a class="docs-heading-anchor" href="#Avoid-agentstate-calls">Avoid agentstate calls</a><a id="Avoid-agentstate-calls-1"></a><a class="docs-heading-anchor-permalink" href="#Avoid-agentstate-calls" title="Permalink"></a></h2><p>Instead of using <a href="transition.html#Vahana.agentstate"><code>agentstate</code></a> to access the state of an agent, sometimes it is possible for an agent to actively send the required state associated with an edge to another agent that needs that information. This can significantly improve performance, especially when combined with the <code>:IgnoreSourceState</code> hint if necessary.</p><p>For example, in a Game of Life implementation, active cells can generate an edge to their neighbors if the cell is active. If this edge has the <code>:NumEdgesOnly</code> hint, it will directly trigger the counting process of the neighbors without the need to transfer the full state to other agents/processes.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="performance.html">« Performance Tuning</a><a class="docs-footer-nextpage" href="definition.html">Model Definition »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Wednesday 12 February 2025 18:00">Wednesday 12 February 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
